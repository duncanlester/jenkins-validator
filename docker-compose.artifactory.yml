services:
  artifactory:
    image: releases-docker.jfrog.io/jfrog/artifactory-oss:latest
    container_name: artifactory
    ports:
      - "8081:8081" # Port for the Artifactory Web UI
    environment:
      # Artifactory configurations
      EXTRA_JAVA_OPTS: "-Xms512m -Xmx2g"
      JFROG_URL: "http://localhost:8081/artifactory"
      ADMIN_USERNAME: "admin"
      ADMIN_PASSWORD: "password"
    volumes:
      - artifactory_data:/var/opt/jfrog/artifactory # Persistent data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8081/artifactory/api/system/ping || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - artifactory-network
    restart: unless-stopped

  bootstrap-npm:
    image: curlimages/curl:7.88.1
    container_name: bootstrap-npm
    depends_on:
      - artifactory
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Waiting for Artifactory to start..."
        until curl -u admin:password -fsSL http://artifactory:8081/artifactory/api/system/ping; do \
          sleep 10; \
        done
        echo "Artifactory is ready. Creating NPM repository..."
        curl -u admin:password \
          -X PUT http://artifactory:8081/artifactory/api/repositories/my-npm-repo \
          -H "Content-Type: application/json" \
          -d '{
                "key": "my-npm-repo",
                "rclass": "local",
                "packageType": "npm",
                "repoLayoutRef": "npm-default"
              }'
        echo "NPM repository 'my-npm-repo' created."
    networks:
      - artifactory-network

volumes:
  artifactory_data: {}

networks:
  artifactory-network:
    driver: bridge
